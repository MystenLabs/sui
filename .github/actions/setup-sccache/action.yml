# Copyright (c) Mysten Labs, Inc.
# SPDX-License-Identifier: Apache-2.0

name: Setup sccache
description: Configure sccache with S3 backend for CI builds with graceful degradation

inputs:
  aws-access-key-id:
    description: AWS access key ID for S3 cache backend
    required: true
  aws-secret-access-key:
    description: AWS secret access key for S3 cache backend
    required: true
  key-prefix:
    description: S3 key prefix for cache partitioning (e.g., ubuntu-ghcloud, windows-ghcloud)
    required: true

runs:
  using: composite
  steps:
    - uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # pin@v5.1.1
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}
        aws-region: us-west-2

    - name: Set sccache environment
      shell: bash
      run: |
        echo "SCCACHE_BUCKET=mystenlabs-sccache" >> "$GITHUB_ENV"
        echo "SCCACHE_REGION=us-west-2" >> "$GITHUB_ENV"
        echo "SCCACHE_S3_KEY_PREFIX=${{ inputs.key-prefix }}" >> "$GITHUB_ENV"

    - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # pin@v0.0.9
      id: sccache
      continue-on-error: true

    - name: Enable sccache
      if: steps.sccache.outcome == 'success'
      shell: bash
      run: echo "RUSTC_WRAPPER=sccache" >> "$GITHUB_ENV"
