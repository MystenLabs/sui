name: Code Coverage
on:
  schedule:
    - cron: '0 9 * * *' # UTC timing is every day at 1am PST
  workflow_dispatch:
    inputs:
      sui_repo_ref:
        description: "Branch / commit to test"
        type: string
        required: false
        default: ''

env:
  CARGO_TERM_COLOR: always
  # Disable incremental compilation.
  #
  # Incremental compilation is useful as part of an edit-build-test-edit cycle,
  # as it lets the compiler avoid recompiling code that hasn't changed. However,
  # on CI, we're not making small edits; we're almost always building the entire
  # project from scratch. Thus, incremental compilation on CI actually
  # introduces *additional* overhead to support making future builds
  # faster...but no future builds will ever occur in any given CI environment.
  #
  # See https://matklad.github.io/2021/09/04/fast-rust-builds.html#ci-workflow
  # for details.
  CARGO_INCREMENTAL: 0
  # Allow more retries for network requests in cargo (downloading crates) and
  # rustup (installing toolchains). This should help to reduce flaky CI failures
  # from transient network timeouts or other issues.
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  # Don't emit giant backtraces in the CI logs.
  RUST_BACKTRACE: short
  # RUSTFLAGS: -D warnings
  RUSTDOCFLAGS: -D warnings

jobs:
  cargo-llvm-cov:
    name: Generate code coverage
    runs-on: [ubuntu-ghcloud]
    timeout-minutes: 240
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Install Rust
        run: rustup update stable
        
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
        with:
            ref: ${{ github.event.inputs.sui_repo_ref || github.ref }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - uses: taiki-e/install-action@protoc
      - name: Add postgres to PATH
        run: echo "/usr/lib/postgresql/14/bin" >> $GITHUB_PATH

      - name: Install Rust toolchain
        run: rustup show active-toolchain || rustup toolchain install

      - name: Set Swap Space
        uses: pierotofy/set-swap-space@fc79b3f67fa8a838184ce84a674ca12238d2c761 # pin@master
        with:
          swap-size-gb: 256
        
      - name: Run code coverage for nextest
        run: RUSTFLAGS="-C debuginfo=0" SUI_SKIP_SIMTESTS=1 cargo llvm-cov --ignore-run-fail --lcov --output-path lcov.info nextest -vv -E '!package(sui-bridge) and !package(sui-bridge-indexer)'

      - name: Upload report to Codecov for nextest
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # pin@v5.5.2
        with:
          files: lcov.info

      - name: Run code coverage for simtest
        run: |
          git clean -fd
          ./scripts/simtest/codecov.sh

      - name: Upload report to Codecov for simtest
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # pin@v5.5.2
        with:
          files: lcov-simtest.info

  notify:
    name: Notify
    needs: [cargo-llvm-cov]
    runs-on: ubuntu-latest
    if: always() # always notify

    steps:
    - uses: technote-space/workflow-conclusion-action@45ce8e0eb155657ab8ccf346ade734257fd196a5 # Pin v4.1.1

    - name: Checkout sui repo
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
      with:
        ref: ${{ github.event.inputs.sui_repo_ref || github.ref }}

    - name: Get sui commit and branch
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        sui_sha=$(git rev-parse HEAD)
        echo "sui_sha=${sui_sha}" >> $GITHUB_ENV

        sui_branch_name=$(gh api -H 'Accept: application/vnd.github+json' /repos/MystenLabs/sui/commits/${sui_sha}/branches-where-head --jq '.[].name' | head -n 1)
        [[ -z $sui_branch_name ]] && sui_branch_name=$(gh api -H 'Accept: application/vnd.github+json' /repos/MystenLabs/sui/commits/${sui_sha}/pulls --jq '.[].base.ref' | head -n 1)
        echo "sui_branch_name=${sui_branch_name}" >> $GITHUB_ENV

    - name: Dispatch to sui-operations for notification
      uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # pin@v4.0.1
      with:
        token: ${{ secrets.OPERATIONS_DISPATCH_TOKEN }}
        repository: MystenLabs/sui-operations
        event-type: code-coverage-notify
        client-payload: |-
          {
            "commit_sha": "${{ env.sui_sha }}",
            "branch_name": "${{ env.sui_branch_name }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "run_id": "${{ github.run_id }}",
            "workflow_name": "${{ github.workflow }}",
            "workflow_conclusion": "${{ env.WORKFLOW_CONCLUSION }}"
          }
