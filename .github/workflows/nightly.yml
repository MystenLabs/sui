name: nightly

on:
  schedule:
    - cron: '0 0 * * *'  # every day at midnight
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # Disable incremental compilation.
  #
  # Incremental compilation is useful as part of an edit-build-test-edit cycle,
  # as it lets the compiler avoid recompiling code that hasn't changed. However,
  # on CI, we're not making small edits; we're almost always building the entire
  # project from scratch. Thus, incremental compilation on CI actually
  # introduces *additional* overhead to support making future builds
  # faster...but no future builds will ever occur in any given CI environment.
  #
  # See https://matklad.github.io/2021/09/04/fast-rust-builds.html#ci-workflow
  # for details.
  CARGO_INCREMENTAL: 0
  # Allow more retries for network requests in cargo (downloading crates) and
  # rustup (installing toolchains). This should help to reduce flaky CI failures
  # from transient network timeouts or other issues.
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10
  # Don't emit giant backtraces in the CI logs.
  RUST_BACKTRACE: short

jobs:
  release:
    name: Build Release Binaries
    runs-on: [ubuntu-ghcloud]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
      - name: cargo build
        run: cargo build --all-targets --all-features --release

  report-failure:
    name: Report Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [release]
    steps:
      - uses: technote-space/workflow-conclusion-action@45ce8e0eb155657ab8ccf346ade734257fd196a5 # Pin v4.1.1

      - name: Checkout sui repo main branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
    
      - name: Get sui commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export sui_sha=$(git rev-parse HEAD)
          echo "sui_sha=${sui_sha}" >> $GITHUB_ENV

      - name: Get current oncall from PagerDuty
        run: |
          # Fetch oncall info including user details (for email)
          response=$(curl -s --max-time 30 --request GET \
            --url 'https://api.pagerduty.com/oncalls?schedule_ids[]=PGCQ3YS&include[]=users' \
            --header 'Accept: application/json' \
            --header 'Authorization: Token token=${{ secrets.PAGERDUTY_ACCESS_KEY }}' \
            --header 'Content-Type: application/json')

          oncall_email=$(echo "$response" | jq -r '.oncalls[0].user.email // empty')
          oncall_user_name=$(echo "$response" | jq -r '.oncalls[0].user.summary // empty')
          oncall_policy=$(echo "$response" | jq -r '.oncalls[0].escalation_policy.summary // empty')

          echo "oncall_email=${oncall_email}" >> "$GITHUB_ENV"
          echo "oncall_user_name=${oncall_user_name}" >> "$GITHUB_ENV"
          echo "oncall_policy=${oncall_policy}" >> "$GITHUB_ENV"

          if [ -z "$oncall_email" ]; then
            echo "::warning::Could not get oncall email from PagerDuty"
          fi

      - name: Get Slack ID for oncall
        run: |
          if [ -z "${{ env.oncall_email }}" ]; then
            echo "::warning::No oncall email available, skipping Slack lookup"
            echo "slack_id=" >> "$GITHUB_ENV"
            exit 0
          fi

          # URL-encode the email for the API call
          encoded_email=$(printf '%s' "${{ env.oncall_email }}" | jq -sRr @uri)

          # Lookup Slack ID from email
          slack_response=$(curl -s --max-time 30 "https://slack.com/api/users.lookupByEmail?email=${encoded_email}" \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}")

          slack_ok=$(echo "$slack_response" | jq -r '.ok')
          slack_id=$(echo "$slack_response" | jq -r '.user.id // empty')

          if [ "$slack_ok" != "true" ]; then
            error=$(echo "$slack_response" | jq -r '.error')
            echo "::warning::Slack lookup failed for ${{ env.oncall_email }}: ${error}"
            echo "slack_id=" >> "$GITHUB_ENV"
            exit 0
          fi

          echo "slack_id=${slack_id}" >> "$GITHUB_ENV" 

      - name: Post to slack
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # pin@v2.1.1
        env:
          SUI_SHA: ${{ env.sui_sha }}
          SLACK_ID: ${{ env.slack_id }}
          ONCALL_USER_NAME: ${{ env.oncall_user_name }}
          ONCALL_POLICY: ${{ env.oncall_policy }}
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: "build-failures-sui"
            text: |
              :sui::error-cross: Workflow *${{ github.workflow }}* has `${{ env.WORKFLOW_CONCLUSION }}`.
              Sui commit: <https://github.com/MystenLabs/sui/commit/${{ env.SUI_SHA }}|${{ env.SUI_SHA }}>
              ${{ env.SLACK_ID && format('<@{0}>', env.SLACK_ID) || env.ONCALL_USER_NAME }}, current `${{ env.ONCALL_POLICY }}` oncall, please debug failures.
              Logs are here: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>
