name: Release Notes Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */3 * * *'  # every 3 hours

# Required for updating repository variables
permissions:
  contents: read
  actions: write

jobs:
  get-list-of-prs:
    name: Get Release Notes for new PRs
    outputs:
      matrix: ${{ steps.get-pr-list.outputs.matrix }}
      new_commit_hash: ${{ steps.get-pr-list.outputs.new_commit_hash }}
      sui_version: ${{ steps.get-pr-list.outputs.sui_version }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout sui repo main branch
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
      with:
        fetch-depth: 0
        ref: main

    - name: Setup Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # pin@v6.2.0
      with:
        python-version: 3.10.10

    - name: Get list of PRs
      id: get-pr-list
      working-directory: ./
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        export new_commit_hash=$(git rev-parse HEAD)

        # Use repo variable to track last processed commit instead of tags
        export last_processed_commit="${{ vars.RELEASE_NOTES_LAST_COMMIT }}"

        # If no last processed commit, use the most recent release notes tag as fallback
        if [ -z "$last_processed_commit" ]; then
          last_processed_commit=$(git tag -l 'sui_v*_rel_notes' --sort=-version:refname | head -n1 || true)
          echo "No RELEASE_NOTES_LAST_COMMIT variable found, falling back to tag: $last_processed_commit"
        fi

        # Use the release_notes.py script to get the list of PRs with release notes
        export list_of_prs=$(python3 ./scripts/release_notes.py list-prs "${last_processed_commit}" "${new_commit_hash}")

        echo "matrix=${list_of_prs}" >> $GITHUB_OUTPUT
        echo "new_commit_hash=${new_commit_hash}" >> $GITHUB_OUTPUT

        export sui_crate_version=$(cat Cargo.toml | grep "^version =" | tr -d '"' | awk '{ print $3 }')
        echo "sui_version=${sui_crate_version}" >> $GITHUB_OUTPUT

  process-prs:
    name: Processing PR
    needs: [ get-list-of-prs ]
    if: ${{ needs.get-list-of-prs.outputs.matrix != '[]' && needs.get-list-of-prs.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
         pr: ${{ fromJson(needs.get-list-of-prs.outputs.matrix) }}

    steps:
    - name: Checkout sui repo main branch
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2
      with:
        ref: main

    - name: Setup Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # pin@v6.2.0
      with:
        python-version: 3.10.10

    - name: Reading Release notes
      id: read-notes
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Processing PR#${{ matrix.pr }}"

        # Use the release_notes.py script to get formatted release notes
        rel_notes=$(python ./scripts/release_notes.py get-notes "${{ matrix.pr }}")

        # make text json payload friendly
        rel_notes=$(sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/\r//g' <<<"$rel_notes")

        # Use random delimiter to prevent injection attacks
        delimiter="EOF_$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64 | tr -d '\n=+/')"
        {
          echo "release_notes<<${delimiter}"
          printf '%s\n' "$rel_notes"
          echo "${delimiter}"
        } >> "$GITHUB_OUTPUT"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # pin@v5.1.1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Get PR author and title
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Fetch PR info (author and title) in one API call
        pr_info=$(gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/MystenLabs/sui/pulls/${{ matrix.pr }})
        author=$(echo "$pr_info" | jq -r ".user.login")
        pr_title=$(echo "$pr_info" | jq -r ".title")

        # Fetch employees.json once and reuse
        employees=$(aws s3 cp s3://mysten-employees-dir/employees.json -)
        slack_id=$(echo "$employees" | jq --arg AUTHOR "${author}" '.[] | if .github_handle == $AUTHOR then .slack_id else empty end')

        # if we don't have the slack id or the author is not part of Mysten org, get the reviewer instead
        if [ -z "$slack_id" ]; then
          reviewer=$(gh api -H "Accept: application/vnd.github+json" -H "X-GitHub-Api-Version: 2022-11-28" /repos/MystenLabs/sui/pulls/${{ matrix.pr }}/reviews --jq ".[0].user.login")
          slack_id=$(echo "$employees" | jq --arg AUTHOR "${reviewer}" '.[] | if .github_handle == $AUTHOR then .slack_id else empty end')
        fi

        # Store slack_id, author, and title for use in Slack message
        echo "slack_id=$(echo ${slack_id} | tr -d '"')" >> $GITHUB_ENV
        echo "author=${author}" >> $GITHUB_ENV
        echo "pr_title=${pr_title}" >> $GITHUB_ENV

    - name: Post to a Slack channel
      uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # pin@v2.1.1
      with:
        method: chat.postMessage
        token: ${{ secrets.SLACK_BOT_TOKEN }}
        payload: |
          channel: "#ext-mysten-release-notes"
          text: |
            ${{ vars.RELEASE_NOTES_REVIEWERS_SLACK_MENTIONS || '' }}${{ vars.RELEASE_NOTES_REVIEWERS_SLACK_MENTIONS && ', please' || 'Please' }} review release notes for upcoming `v${{ needs.get-list-of-prs.outputs.sui_version }}` release.
            *PR* <https://github.com/MystenLabs/sui/pull/${{ matrix.pr }}|#${{ matrix.pr }}: ${{ env.pr_title }}> by ${{ env.slack_id && format('<@{0}>', env.slack_id) || format('`{0}` (external contributor)', env.author) }}
            *Release Notes:*
            ${{ steps.read-notes.outputs.release_notes }}

  update-last-processed-commit:
    name: Update last processed commit
    needs: [ get-list-of-prs, process-prs ]
    if: ${{ always() && needs.get-list-of-prs.result == 'success' && (needs.process-prs.result == 'success' || needs.process-prs.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
    - name: Update RELEASE_NOTES_LAST_COMMIT variable
      env:
        # Requires a PAT with repo scope to update repository variables
        GH_TOKEN: ${{ secrets.SUI_CREATE_RELEASE }}
      run: |
        gh variable set RELEASE_NOTES_LAST_COMMIT \
          --repo MystenLabs/sui \
          --body "${{ needs.get-list-of-prs.outputs.new_commit_hash }}"
        echo "Updated RELEASE_NOTES_LAST_COMMIT to ${{ needs.get-list-of-prs.outputs.new_commit_hash }}"
