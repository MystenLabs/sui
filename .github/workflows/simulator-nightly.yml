name: Simulator Tests

concurrency:
  group: ${{ github.workflow }}

on:
  schedule:
    - cron: '0 9 * * *' # equivalent to 1am PST
    - cron: '0 21 * * *' # equivalent to 1pm PST
  workflow_dispatch:
    inputs:
      sui_ref:
        description: "Branch / commit to test"
        type: string
        required: true
        default: main
      test_num:
        description: "MSIM_TEST_NUM (test iterations)"
        type: string
        required: false
        default: "30"
      protocol_config_override:
        description: "Protocol config override"
        type: string
        required: false
        default: ""

env:
  SUI_REF: "${{ github.event.inputs.sui_ref || 'main' }}"
  TEST_NUM: "${{ github.event.inputs.test_num || '30' }}"

jobs:
  simtest:
    # Allow running the job for up to 6 hours, maximum for GitHub Actions.
    timeout-minutes: 360
    permissions:
      # The "id-token: write" permission is required or Machine ID will not be
      # able to authenticate with the cluster.
      id-token: write
      contents: read
    runs-on: ubuntu-latest

    steps:
      - name: Install Teleport
        uses: teleport-actions/setup@a820ebbf1bc1a496efca348ad21042d6e8df73a6 # pin@v1.1.0
        with:
          version: 18.2.0
      - name: Authorize against Teleport
        id: auth
        uses: teleport-actions/auth@d48447391aa28b202c98ae3f3358097025c32511 # pin@v2.0.4
        with:
          # Specify the publically accessible address of your Teleport proxy.
          proxy: mysten.teleport.sh:443
          # Specify the name of the join token for your bot.
          token: sui-simtest-token
          # Specify the length of time that the generated credentials should be
          # valid for. This is optional and defaults to "1h"
          certificate-ttl: 6h
      - name: Show Teleport cert details
        run: tsh -i ${{ steps.auth.outputs.identity-file }} status
        env:
          TELEPORT_IDENTITY_FILE: ${{ env.TELEPORT_IDENTITY_FILE }}
      # Cargo clean and git restore on any left over files from git checkout, and deletes all remote tracking branches
      - name: Environment clean
        run: |
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 echo 'teleport OK'
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && rm -rf ~/sui"
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && cd ~/ && git clone git@github.com:MystenLabs/sui.git"
 
      # Deleting files in tmpfs that usually fill up pretty quickly after each run. Cargo clean to free up space as well.
      - name: Tmpfs and cargo clean
        run: |  
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "sudo rm -rf /tmp/*"
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && cd ~/sui && cargo clean"

      # Checkout out the latest sui repo
      - name: Checkout sui repo
        run: |
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && cd ~/sui && git fetch origin && git checkout ${{ env.SUI_REF }}"

      # Setting up cargo and simtest
      - name: Install simtest
        run: |
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && cd ~/sui && ./scripts/simtest/install.sh"

      - name: Set protocol config override based on trigger
        id: protocol
        # This step determines which protocol config override to use.
        # It checks if the trigger was a manual dispatch or a specific schedule.
        run: |
          message=""
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.protocol_config_override }}" ]]; then
              echo "Testing with protocol config override: ${{ github.event.inputs.protocol_config_override }}"
              echo "SUI_PROTOCOL_CONFIG_CHAIN_OVERRIDE=${{ github.event.inputs.protocol_config_override }}" >> $GITHUB_ENV
            else
              echo "Testing latest protocol config for dispatched run"
            fi
          elif [[ "${{ github.event.schedule }}" == "0 21 * * *" ]]; then
            echo "Testing mainnet protocol config"
            echo "SUI_PROTOCOL_CONFIG_CHAIN_OVERRIDE=mainnet" >> $GITHUB_ENV
            message="(mainnet config) "
          else
            echo "Testing latest protocol config"
          fi
          # Set the output for other jobs to use
          echo "protocol_message=${message}" >> $GITHUB_OUTPUT

      # Run simulator tests
      - name: Run simtest
        run: |
          tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "source ~/.bashrc && source ~/.cargo/env && cd ~/sui && RUSTUP_MAX_RETRIES=10 CARGO_TERM_COLOR=always CARGO_INCREMENTAL=0 CARGO_NET_RETRY=10 RUST_BACKTRACE=short RUST_LOG=off NUM_CPUS=24 TEST_NUM=${{ env.TEST_NUM }} ./scripts/simtest/simtest-run.sh"

      - name: Collect failing tests
        id: failures
        if: failure()
        run: |
          LOG_DIR=$(tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "ls -td ~/simtest_logs/*/ | head -1")
          FAILED_TESTS=$(tsh -i ${{ steps.auth.outputs.identity-file }} ssh ubuntu@simtest-01 "sed 's/\x1b\[[0-9;]*m//g' ${LOG_DIR}* 2>/dev/null | grep -E '^\s*(FAIL|TIMEOUT)\s+\[' | sed -E 's/^\s*(FAIL|TIMEOUT)\s+\[[^]]+\]\s+//' | sort -u | head -20")
          echo "failed_tests<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "log_dir=$LOG_DIR" >> $GITHUB_OUTPUT

    outputs:
      failed_tests: ${{ steps.failures.outputs.failed_tests }}
      log_dir: ${{ steps.failures.outputs.log_dir }}
      protocol_message: ${{ steps.protocol.outputs.protocol_message }}

  notify:
    name: Notify
    needs: [simtest]
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && failure()

    steps:
    - uses: technote-space/workflow-conclusion-action@45ce8e0eb155657ab8ccf346ade734257fd196a5 # Pin v4.1.1

    - name: Get sui commit
      run: echo "sui_sha=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Dispatch to sui-operations for notification
      uses: peter-evans/repository-dispatch@28959ce8df70de7be546dd1250a005dd32156697 # pin@v4.0.1
      with:
        token: ${{ secrets.DOCKER_BINARY_BUILDS_DISPATCH }}
        repository: MystenLabs/sui-operations
        event-type: simtest-failure
        client-payload: |-
          {
            "commit_sha": "${{ env.sui_sha }}",
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "run_id": "${{ github.run_id }}",
            "workflow_name": "${{ github.workflow }}",
            "workflow_conclusion": "${{ env.WORKFLOW_CONCLUSION }}",
            "protocol_message": "${{ needs.simtest.outputs.protocol_message }}",
            "failed_tests": ${{ toJSON(needs.simtest.outputs.failed_tests) }},
            "log_dir": "${{ needs.simtest.outputs.log_dir }}"
          }
