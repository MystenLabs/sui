name: üîî Alert on upstream sui.yaml change

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 * * *" 
  workflow_dispatch:

jobs:
  alert-on-change:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add & Fetch Upstream
        run: |
          git remote add upstream https://github.com/MystenLabs/sui.git || true
          git fetch upstream main

      - name: Restore previous commit hash from cache
        id: restore_cache
        uses: actions/cache/restore@v3
        with:
          path: .last_file_commit
          key: sui-yaml-commit-${{ github.run_id }}
          restore-keys: sui-yaml-commit-

      - name: Get last commit affecting sui.yaml
        id: get_commit
        run: |
          last_commit=$(git log -n 1 --pretty=format:'%H' upstream/main -- crates/sui-core/tests/staged/sui.yaml) 
          echo "LAST_COMMIT=$last_commit" >> $GITHUB_ENV
          echo "Last commit: $last_commit"

      - name: Compare with previous commit
        id: check_change
        run: |
          prev_commit=$(cat .last_file_commit 2>/dev/null || echo "")
          echo "Previous commit: $prev_commit"
          echo "Current commit: $LAST_COMMIT"
          
          if [ "$LAST_COMMIT" != "$prev_commit" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Change detected! Updating commit hash..."
            echo "$LAST_COMMIT" > .last_file_commit
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No change detected."
          fi

      - name: Send Slack Alert
        if: steps.check_change.outputs.changed == 'true'
        run: |
          response=$(curl -w "%{http_code}" -s -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"üö® *sui.yaml was updated in upstream!*\n‚Ä¢ Commit: *<${COMMIT_URL}|${COMMIT_HASH}>*\n‚Ä¢ Author: ${COMMIT_AUTHOR}\n‚Ä¢ Message: ${COMMIT_MSG}\n${SLACK_MENTIONS}\"}" \
            ${{ secrets.SLACK_ALERT_NOODLES_WEBHOOK }})
          
          if [ "${response: -3}" = "200" ]; then
            echo "‚úÖ Slack notification sent successfully"
          else
            echo "‚ùå Failed to send Slack notification. Response: $response"
            exit 1
          fi

      - name: Save commit hash to cache
        if: steps.check_change.outputs.changed == 'true' 
        uses: actions/cache/save@v3
        with:
          path: .last_file_commit
          key: sui-yaml-commit-${{ github.run_id }} 