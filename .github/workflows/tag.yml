name: Tag

on:
  repository_dispatch:
    types: [tag-main]

  workflow_call:
    inputs:
      sui_commit:
        description: 'Sui repo commit to tag'
        type: string
        required: true
      tag_name:
        description: 'Tag Name'
        type: string
        required: true
  workflow_dispatch:
    inputs:
      sui_commit:
        description: 'Sui repo commit to tag'
        type: string
        required: true
      tag_name:
        description: 'Tag Name'
        type: string
        required: true

permissions:
  contents: write

env:
  SUI_COMMIT: "${{ github.event.client_payload.sui_commit || inputs.sui_commit }}"
  TAG_NAME: "${{ github.event.client_payload.tag_name || inputs.tag_name }}"

jobs:
  tag:
    name: Tag
    runs-on: ubuntu-latest

    steps:
    - name: Create or update tag via GitHub API
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # pin@v7.0.1
      with:
        script: |
          const tag = process.env.TAG_NAME;
          const sha = process.env.SUI_COMMIT;

          console.log(`Creating/updating tag ${tag} to point to ${sha}`);

          try {
            // Try to update existing tag
            await github.rest.git.updateRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${tag}`,
              sha: sha,
              force: true
            });
            console.log(`Updated existing tag ${tag}`);
          } catch (e) {
            if (e.status === 404) {
              // Tag doesn't exist, create it
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: sha
              });
              console.log(`Created new tag ${tag}`);
            } else {
              throw e;
            }
          }

          console.log(`Tag ${tag} now points to ${sha}`);
