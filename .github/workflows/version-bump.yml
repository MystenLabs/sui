name: Sui Version Bump
run-name: "Sui Version Bump (${{ inputs.type }})"

on:
  workflow_call:
    inputs:
      type:
        description: "Bump type: patch or minor"
        type: string
        required: false
        default: "minor"
      delivery:
        description: "Delivery method: pr or direct"
        type: string
        required: false
        default: "pr"

  workflow_dispatch:
    inputs:
      type:
        description: "Bump type"
        type: choice
        required: true
        default: "patch"
        options:
          - patch
          - minor
      delivery:
        description: "Delivery method"
        type: choice
        required: true
        default: "pr"
        options:
          - pr
          - direct

concurrency:
  group: version-bump-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    name: Bump Version
    runs-on: ubuntu-ghcloud

    steps:
      - name: Validate inputs
        env:
          INPUT_TYPE: ${{ inputs.type }}
          INPUT_DELIVERY: ${{ inputs.delivery }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [[ "$INPUT_TYPE" != "patch" && "$INPUT_TYPE" != "minor" ]]; then
            echo "::error::Invalid input: 'type' must be 'patch' or 'minor', got '$INPUT_TYPE'"
            exit 1
          fi
          if [[ "$INPUT_DELIVERY" != "pr" && "$INPUT_DELIVERY" != "direct" ]]; then
            echo "::error::Invalid input: 'delivery' must be 'pr' or 'direct', got '$INPUT_DELIVERY'"
            exit 1
          fi
          if [[ "$INPUT_DELIVERY" == "direct" && "$REF_NAME" == "main" ]]; then
            echo "::error::Cannot direct-push to main. Use delivery=pr instead."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # pin@v6.0.2

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run version bump
        id: bump
        env:
          INPUT_TYPE: ${{ inputs.type }}
        run: |
          ./scripts/version-bump.sh --type "$INPUT_TYPE" -y 2>&1 | tee /tmp/bump-output.txt
          # Extract the new version from the script output
          NEW_VERSION=$(grep '^NEW_VERSION=' /tmp/bump-output.txt | cut -d= -f2)
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Deliver via PR
        if: inputs.delivery == 'pr'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          STAMP="$(date +%Y%m%d%H%M%S)"
          BRANCH="${GITHUB_ACTOR}/sui-v${NEW_VERSION}-version-bump-${STAMP}"

          git checkout -b "$BRANCH"
          git add \
            Cargo.toml \
            Cargo.lock \
            crates/sui-open-rpc/spec/openrpc.json \
            crates/sui-open-rpc/tests/snapshots/generate_spec__openrpc.snap.json
          BODY="Sui v${NEW_VERSION} Version Bump"
          git commit -m "$BODY"
          git push -u origin "$BRANCH"

          gh pr create \
            --base "$REF_NAME" \
            --head "$BRANCH" \
            --title "$BODY" \
            --reviewer "ebmifa,pei-mysten,tharbert" \
            --body "$BODY"

          gh pr merge --auto --squash --delete-branch "$BRANCH"

      - name: Deliver direct push
        if: inputs.delivery == 'direct'
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          BODY="Sui v${NEW_VERSION} Version Bump"

          git add \
            Cargo.toml \
            Cargo.lock \
            crates/sui-open-rpc/spec/openrpc.json \
            crates/sui-open-rpc/tests/snapshots/generate_spec__openrpc.snap.json
          git commit -m "$BODY"
          git push origin HEAD:"$REF_NAME"
