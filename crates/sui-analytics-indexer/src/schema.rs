// Copyright (c) Mysten Labs, Inc.
// SPDX-License-Identifier: Apache-2.0

//! Row schema abstraction for columnar data serialization.
//!
//! This module provides a generic abstraction for serializing table rows to columnar
//! formats like CSV and Parquet. The `RowSchema` trait and `ColumnValue` enum work
//! together to enable format-agnostic row serialization.

use std::borrow::Cow;
use std::sync::Arc;

use sui_types::dynamic_field::DynamicFieldType;
use thiserror::Error;

use crate::tables::InputObjectKind;
use crate::tables::ObjectStatus;
use crate::tables::OwnerType;

/// Error type for column access operations.
#[derive(Debug, Error)]
pub enum ColumnError {
    #[error("invalid column index {0}")]
    InvalidIndex(usize),
}

/// Represents a single column value in a row.
///
/// This enum provides a type-safe way to represent different column value types
/// that can be serialized to columnar formats. Uses `Cow<str>` to enable zero-copy
/// borrowing for string fields.
pub enum ColumnValue<'a> {
    U64(u64),
    Str(Cow<'a, str>),
    Bool(bool),
    I64(i64),
    OptionU64(Option<u64>),
    OptionStr(Option<Cow<'a, str>>),
}

// Copy types - dereference from reference
impl<'a> From<&'a u64> for ColumnValue<'a> {
    fn from(value: &'a u64) -> Self {
        Self::U64(*value)
    }
}

impl<'a> From<&'a i64> for ColumnValue<'a> {
    fn from(value: &'a i64) -> Self {
        Self::I64(*value)
    }
}

impl<'a> From<&'a bool> for ColumnValue<'a> {
    fn from(value: &'a bool) -> Self {
        Self::Bool(*value)
    }
}

impl<'a> From<&'a Option<u64>> for ColumnValue<'a> {
    fn from(value: &'a Option<u64>) -> Self {
        Self::OptionU64(*value)
    }
}

// String types - zero-copy borrow
impl<'a> From<&'a String> for ColumnValue<'a> {
    fn from(value: &'a String) -> Self {
        Self::Str(Cow::Borrowed(value.as_str()))
    }
}

impl<'a> From<&'a Option<String>> for ColumnValue<'a> {
    fn from(value: &'a Option<String>) -> Self {
        Self::OptionStr(value.as_ref().map(|s| Cow::Borrowed(s.as_str())))
    }
}

// Enum types - must allocate since they use Display::to_string()
impl<'a> From<&'a OwnerType> for ColumnValue<'a> {
    fn from(value: &'a OwnerType) -> Self {
        Self::Str(Cow::Owned(value.to_string()))
    }
}

impl<'a> From<&'a Option<OwnerType>> for ColumnValue<'a> {
    fn from(value: &'a Option<OwnerType>) -> Self {
        Self::OptionStr(value.as_ref().map(|v| Cow::Owned(v.to_string())))
    }
}

impl<'a> From<&'a ObjectStatus> for ColumnValue<'a> {
    fn from(value: &'a ObjectStatus) -> Self {
        Self::Str(Cow::Owned(value.to_string()))
    }
}

impl<'a> From<&'a Option<ObjectStatus>> for ColumnValue<'a> {
    fn from(value: &'a Option<ObjectStatus>) -> Self {
        Self::OptionStr(value.as_ref().map(|v| Cow::Owned(v.to_string())))
    }
}

impl<'a> From<&'a Option<InputObjectKind>> for ColumnValue<'a> {
    fn from(value: &'a Option<InputObjectKind>) -> Self {
        Self::OptionStr(value.as_ref().map(|v| Cow::Owned(v.to_string())))
    }
}

impl<'a> From<&'a DynamicFieldType> for ColumnValue<'a> {
    fn from(value: &'a DynamicFieldType) -> Self {
        Self::Str(Cow::Owned(value.to_string()))
    }
}

impl<'a> From<&'a Option<DynamicFieldType>> for ColumnValue<'a> {
    fn from(value: &'a Option<DynamicFieldType>) -> Self {
        Self::OptionStr(value.as_ref().map(|v| Cow::Owned(v.to_string())))
    }
}

/// Trait for types that can describe their columnar schema and provide column values.
///
/// This trait enables generic serialization of row types to columnar formats.
/// Implementations are typically generated by the `SerializeRow` derive macro.
///
/// The trait is object-safe: `schema()` has a `Self: Sized` bound which excludes it
/// from the vtable, while `column_count()` and `get_column()` can be called on trait objects.
pub trait RowSchema {
    /// Returns the column names for this row type.
    ///
    /// This method requires `Self: Sized` and cannot be called on trait objects.
    /// Use `column_count()` for the number of columns when working with `dyn RowSchema`.
    fn schema() -> &'static [&'static str]
    where
        Self: Sized;

    /// Returns the number of columns in the schema.
    ///
    /// This is an object-safe alternative to `schema().len()` for use with trait objects.
    fn column_count(&self) -> usize;

    /// Returns the value at the given column index.
    ///
    /// Returns an error if the index is out of bounds.
    fn get_column(&self, idx: usize) -> Result<ColumnValue<'_>, ColumnError>;
}

/// Blanket implementation for `Arc<T>` - delegates to inner type.
/// This allows processors to return `Arc<RowType>` while still satisfying `RowSchema`.
impl<T: RowSchema> RowSchema for Arc<T> {
    fn schema() -> &'static [&'static str]
    where
        Self: Sized,
    {
        T::schema()
    }

    fn column_count(&self) -> usize {
        (**self).column_count()
    }

    fn get_column(&self, idx: usize) -> Result<ColumnValue<'_>, ColumnError> {
        (**self).get_column(idx)
    }
}
