// Copyright (c) Mysten Labs, Inc.
// SPDX-License-Identifier: Apache-2.0

#[test_only]
module sui::nitro_attestation_tests;

use std::unit_test::assert_eq;
use sui::nitro_attestation;
use sui::test_scenario;

#[test]
fun test_nitro_attestation() {
    let mut scenario = test_scenario::begin(@0x0);
    let ctx = scenario.ctx();
    // payload from the example weather enclave: https://github.com/MystenLabs/nautilus
    let payload =
        x"8444a1013822a059111fa9696d6f64756c655f69647827692d30366534623938633635343966663830332d656e633031393633373362313935666237323366646967657374665348413338346974696d657374616d701b00000196c5942c426470637273b0005830cbe1afb6ed0ff89f10295af0b802247ec5670da8f886e71a4226373b032c322f4e42c9c98288e7211682b258684505a2015830cbe1afb6ed0ff89f10295af0b802247ec5670da8f886e71a4226373b032c322f4e42c9c98288e7211682b258684505a202583021b9efbc184807662e966d34f390821309eeac6802309798826296bf3e8bec7c10edb30948c90ba67310f7b964fc500a0358309af4960cd10ff0ddb81dc6660d16bf92165923d7ce3cbc53b9e42257424049b55bf459ca68ba632f39ff510064293c5f045830f3e18816e8d0ba69088d034522e742f0e1909ab34d5e83a1f579ffb43c58f0f0f35d64401efc9426097565d0506a8a5f0558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b636572746966696361746559027f3082027b30820201a00302010202100196373b195fb7230000000068223238300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30366534623938633635343966663830332e75732d656173742d312e6177732e6e6974726f2d656e636c61766573301e170d3235303531323137333930315a170d3235303531323230333930345a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30366534623938633635343966663830332d656e63303139363337336231393566623732332e75732d656173742d312e6177733076301006072a8648ce3d020106052b8104002203620004afc36638fc9d70b2f9471753bcd890caaea79ae3881bfa6addbfe9a2142bc3eec9bd47c0f4c3dff198bc34311b60a33a07e66e7e347cc40d4b4b2da3c9a275320d0b248b8a03d4a2fe6aec1c58ebe6ff075de44e90e3916f323187f356de3b58a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030368003065023019d7896564d908ef5ec2b460f45b02c8476310d258e748f23bda16da21a3aa199675e89d134fe4f1d086b6dd89821087023100d64f51af692f581c66bd912f01d0b699c240428d681d990be5553c8e08dfbc6837aac8b3c312fcd31e75aa6756b5f45c68636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c3308202bf30820245a003020102021100d464b0d7cde4e963d4066b0e123a721c300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3235303531313133333235355a170d3235303533313134333235355a3064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d326365363237653230363639663632612e75732d656173742d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200048aa63a37ec803f56f189843be40ea6c237240530f3a961ac8e34a93cb51a42937c4778818a22f4a3c08dc8c36775e69c536883b85c6ee60cc194ba5fb0a1160dabe3c803dce6639029172bf5a7d962c39b6b65ae22d8924331d74f5e6de117aba381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414e878dcab1a772e6e04a93422cfd8f874e2db0365300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d040303036800306502302a361ebee5a19f0be1be7b7672574764cce74ffc24144c7de18f59b7c24b74f8419b23d8a7f17cc2a7c1ba21bc5363d0023100c02521bec78aafad295ec0a4c6f3000f0a027e685a82b1786ed81b3e6b7fb4c05c63e8d72d8268bf7bd7eac06512db51590318308203143082029aa0030201020210733f318d0cce6f98a1821669f1fb2305300a06082a8648ce3d0403033064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d326365363237653230363639663632612e75732d656173742d312e6177732e6e6974726f2d656e636c61766573301e170d3235303531323035323631315a170d3235303531383035323631315a308189313c303a06035504030c33633835383165613839343063363062302e7a6f6e616c2e75732d656173742d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b81040022036200047e59593a2daf01a4d7bd56b7f96b7af9e526db7d1e8f1b8b0fc8a5c1a7190c3a5f274cd6eda4464930d020d94ebd9cad902a7d826d59a5a7055fb06990a9f259983d95c60c04a9072ce813a69f7a4e1165de38474aad12d16a029cd17006fa36a381ea3081e730120603551d130101ff040830060101ff020101301f0603551d23041830168014e878dcab1a772e6e04a93422cfd8f874e2db0365301d0603551d0e0416041407db13d8fa99d46a52d0855c91704352c1d96ad0300e0603551d0f0101ff0404030201863081800603551d1f047930773075a073a071866f687474703a2f2f63726c2d75732d656173742d312d6177732d6e6974726f2d656e636c617665732e73332e75732d656173742d312e616d617a6f6e6177732e636f6d2f63726c2f61633566666261642d303639302d343737392d616265652d6333666431366537666232362e63726c300a06082a8648ce3d04030303680030650230407bb62b98ea88dae5c72d465e21764b69da09ffe8d24d03ce7f2094c212b23bb05d95534190093e6e2e2ca9c49ca3aa023100f09036ac72014491432fbe0076ef396c55c055eaf58beca6155621ae4784eb1e03f71a0a40e8b760b67b7f6162269ef95902c1308202bd30820244a003020102021426a94cb3de052fd01178ec9f2da990de10ae50c6300a06082a8648ce3d040303308189313c303a06035504030c33633835383165613839343063363062302e7a6f6e616c2e75732d656173742d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3235303531323134333533325a170d3235303531333134333533325a30818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30366534623938633635343966663830332e75732d656173742d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200049f84fd231f0332361556d06121290b042aba0fc8119cf62b530a34fde2ba0a5213eaf4bcd79cd240492f51702315beebedc7c29d42a72912e0add5975ff35fe8ac7b9167ad19b2984114aa5c6bc466a20d63e5f2bb5d7dc4a9e7a6400545d95fa366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e0416041431b3f2a9c91d2fbfe1230f702391caeec8567e0d301f0603551d2304183016801407db13d8fa99d46a52d0855c91704352c1d96ad0300a06082a8648ce3d04030303670030640230583f4115d2b95b86c3c6ee27cc01a6b6db0ca0eb6bdf3201e9633b86ffa22197c9fe60d057f67def74501a0f26ea311702302aba979960bf724ca89894971d8db95741ea2447cc1729abd6734d555c0023d61cda01ae9e43f0adc90c9ff85e82dfc06a7075626c69635f6b65795820e8e62201dbe293b703c759f653107acbc2c911fa1d2e66f2c747bec95971a2af69757365725f64617461f6656e6f6e6365f658606c09606f0fab68546bfa94e5b99170783005f830d40eb626cb0c0d5e3aae805d0a4ac3a32576db1b40875826b14720f14d92839610f8c34d7cade1f9f1ac01e9fe95b806d2ebe945f7ce8258a32453e5a2ffb8d6a8bc83a7b4153e863195ec5d";
    let mut clock = sui::clock::create_for_testing(ctx);
    clock.set_for_testing(1747071568899);
    let res = nitro_attestation::load_nitro_attestation(payload, &clock);
    std::debug::print(res.pcrs());
    assert!(res.pcrs().length() == 5);

    assert!(res.pcrs()[0].index() == 0);
    assert!(
        res.pcrs()[0].value() == x"cbe1afb6ed0ff89f10295af0b802247ec5670da8f886e71a4226373b032c322f4e42c9c98288e7211682b258684505a2",
    );

    assert!(res.pcrs()[1].index() == 1);
    assert!(
        res.pcrs()[1].value() == x"cbe1afb6ed0ff89f10295af0b802247ec5670da8f886e71a4226373b032c322f4e42c9c98288e7211682b258684505a2",
    );

    assert!(res.pcrs()[2].index() == 2);
    assert!(
        res.pcrs()[2].value() == x"21b9efbc184807662e966d34f390821309eeac6802309798826296bf3e8bec7c10edb30948c90ba67310f7b964fc500a",
    );

    assert!(res.pcrs()[3].index() == 3);
    assert!(
        res.pcrs()[3].value() == x"9af4960cd10ff0ddb81dc6660d16bf92165923d7ce3cbc53b9e42257424049b55bf459ca68ba632f39ff510064293c5f",
    );

    assert!(res.pcrs()[4].index() == 4);
    assert!(
        res.pcrs()[4].value() == x"f3e18816e8d0ba69088d034522e742f0e1909ab34d5e83a1f579ffb43c58f0f0f35d64401efc9426097565d0506a8a5f",
    );

    assert!(res.user_data().is_none());
    assert!(res.nonce().is_none());
    assert_eq!(
        *res.public_key().borrow(),
        x"e8e62201dbe293b703c759f653107acbc2c911fa1d2e66f2c747bec95971a2af",
    );

    scenario.end();
    clock.destroy_for_testing();
}
#[test]
fun test_nitro_pcr_17attestation() {
        let mut scenario = test_scenario::begin(@0x0);
    let ctx = scenario.ctx();
    // payload from the example weather enclave: https://github.com/MystenLabs/nautilus
    let payload =
        x"8444a1013822a059115dbf696d6f64756c655f69647827692d30366662306266346537306435313239662d656e633031396135333736393939303431623166646967657374665348413338346974696d657374616d701b0000019a6ec8483c6470637273b10058303aa0e6e6ed7d8301655fced7e6ddcc443a3e57bf62f070caa6becf337069e859c0f03d68136440ff1cab8adefd20634c015830b0d319fa64f9c2c9d7e9187bc21001ddacfab4077e737957fa1b8b97cc993bed43a79019aebfd40ee5f6f213147909f8025830fdb2295dc5d9b67a653ed5f3ead5fc8166ec3cae1de1c7c6f31c3b43b2eb26ab5d063f414f3d2b93163426805dfe057e035830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000045830fc4a2e95325943566b6344b99d998df9675cb30e32a1eaf7d74767d818e715f1e289d09b9e5dbceb8245607ffe661b460558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f583000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010583028827566f8b004a75ccd77ffab1813059cfc384b3b23f926728263fecb03e97d4928fbef613791fcb233d7b16ad74b946b63657274696669636174655902823082027e30820203a0030201020210019a5376999041b10000000069121eca300a06082a8648ce3d04030330818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30366662306266346537306435313239662e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3235313131303137323030375a170d3235313131303230323031305a308194310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313f303d06035504030c36692d30366662306266346537306435313239662d656e63303139613533373639393930343162312e61702d736f7574682d312e6177733076301006072a8648ce3d020106052b81040022036200044cecf4194546b5bed057743d3b17aeb423dfda0a89c3a28213a44ec898bfaa37b9900343a5acf50d30c13b6e2a2e185de0d2ba98983b0fd9e7622c7082cd36b2085decf366a13e5737a50e810bbd8e3b1af389ae047f457c1c7c8481619018f3a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100844a418ab89ac9fc6d49ca3070fc5e22257e8670a749067278621fa11b660d7f81d1f364a48ee7d98d0a198cf0803b4e023100edf4ae664cf49ad0fafb41a56b2ad005d038f47f9f294f90195619f6a3314561fbe62b9330c03f8f8f5ad841245b27da68636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c4308202c030820245a00302010202105c6c380c7169a2c406db2adebfc402c3300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3235313130353139323535345a170d3235313132353230323535345a3065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e386435646337356239383631626631372e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b810400220362000482b42bc5e60e557e947aa07d8478ce7b26017ff54b4f31e3ee1201ab3c9ba09d341d058386812608536fca9b306175b8a838fe43f719a31cd044f1fb9e0fa7bcb3e66532a9103e8d782f3d1e4ad3fe7f44526063e3e9282b852364e7efc699bea381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e041604146597f652cb83b2039635b39fda78a31181a0d551300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d0403030369003066023100cd9577b0282bd71935d06f52c45b1302b69e884d3976c587d9f24ddc90af7bd57ce936df4b819a30cebde1447cf9e7dd023100e66e67a30e47d177a906cfa60262364a9fd1bf973a2ee674e1a46c9ad65d79e06cf26f02acaf668823f6f6e86e61cfbc59031c308203183082029ea003020102021100d1abc6cd83360b04efadad7b076d2a9d300a06082a8648ce3d0403033065310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533137303506035504030c2e386435646337356239383631626631372e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573301e170d3235313131303032313035355a170d3235313131353232313035355a308189313c303a06035504030c333838346261363561376531353162352e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b8104002203620004259405cd59e6e9a449f01e8d848a2d2227cab6c1dd01cf93b6aeb5f8532af876a5392565332f0de0bcaa26528811d9e35ca9c631dbf679e8a64841d2d65ee3423aaf1f32caf755ddf7a25bd43eaedaff9554c6812e87104c7122d5c00cb7e8f9a381ec3081e930120603551d130101ff040830060101ff020101301f0603551d230418301680146597f652cb83b2039635b39fda78a31181a0d551301d0603551d0e04160414b5d3e88bb519c1626118de4fbb65f0299f3dbd2f300e0603551d0f0101ff0404030201863081820603551d1f047b30793077a075a0738671687474703a2f2f63726c2d61702d736f7574682d312d6177732d6e6974726f2d656e636c617665732e73332e61702d736f7574682d312e616d617a6f6e6177732e636f6d2f63726c2f36623938353062612d393238332d346130332d383136372d3033663437306338636435372e63726c300a06082a8648ce3d0403030368003065023100c6934996a65a014b29968565bed05a17596c5814dcfb541f35726590202e08ea33044b7104c58b87dac9887413a5dac502306d0c0c2e206514a6976810d9a89581c0b8f295063f8f2e114eabda9f841269e7048ca56df727ccde0eb2ae992c25c09e5902c3308202bf30820245a00302010202142a9784f048ad362becfdec98bc824fc65ed7cf73300a06082a8648ce3d040303308189313c303a06035504030c333838346261363561376531353162352e7a6f6e616c2e61702d736f7574682d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3235313131303038313735335a170d3235313131313038313735335a30818f310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313a303806035504030c31692d30366662306266346537306435313239662e61702d736f7574682d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200048695b204a7cfaac9c6e0efea28cfee2d0eebd5571088f26d63fe52d5f2e71be5dd9f7a87c2fabf919c7f4de42b779c51a62c31ce85b2eee236f9fd85cfd0c1e369b27a1d9a17b9449c45c091fe4f478e001d1451c232c1b352b4fd08208b8165a366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e04160414987e298c478af20045afa06fada37bd95f5651d1301f0603551d23041830168014b5d3e88bb519c1626118de4fbb65f0299f3dbd2f300a06082a8648ce3d04030303680030650230793561db5333f8e88c56b9b147556b0c0f9593b73e72f2e3b424f6bf3942801076052dda3a75212d8790c2ff56d06796023100c7822498ec9b9973c2e07d3f1cb16174d838639124863de7e2173bd843a620071dd678dadfd7264d8711f374a6e1aa306a7075626c69635f6b65795820c68116a630c8bdde83fe1c5a6ff12b5a4f93404e2fc112824d151ed42bf98a2069757365725f6461746140656e6f6e6365f6ff586067970dd36b0bac250de1f1486daa48cc46a72c8cbae30dcb4222768010657e9476db8bf88e6761dc51a31622121de4279e890944823068d541309563e573fcfa18ab152f6476f587254816055d6add843fa6564e6e20c2f0cc8d4690620bc7fe";
    let mut clock = sui::clock::create_for_testing(ctx);
    clock.set_for_testing(1762795380000);
    let res = nitro_attestation::load_nitro_attestation(payload, &clock);
    std::debug::print(res.pcrs());
    assert!(res.pcrs()[16].index() == 16);
    scenario.end();
    clock.destroy_for_testing();
}

#[test]
#[expected_failure(abort_code = nitro_attestation::EParseError)]
fun test_nitro_attestation_invalid_attestation() {
    let mut scenario = test_scenario::begin(@0x0);
    let ctx = scenario.ctx();
    let mut clock = sui::clock::create_for_testing(ctx);
    clock.set_for_testing(1731627987382);
    let payload = x"0000";
    nitro_attestation::load_nitro_attestation(payload, &clock);
    scenario.end();
    clock.destroy_for_testing();
}

#[test]
#[expected_failure(abort_code = nitro_attestation::EVerifyError)]
fun test_nitro_attestation_expired() {
    let mut scenario = test_scenario::begin(@0x0);
    let ctx = scenario.ctx();
    let payload =
        x"8444a1013822a0591121a9696d6f64756c655f69647827692d30663733613462346362373463633966322d656e633031393265343138386665663738316466646967657374665348413338346974696d657374616d701b000001932d1239ca6470637273b0005830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000015830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000025830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000035830639a8b65f68b0223cbb14a0032487e5656d260434e3d1a10e7ec1407fb86143860717fc8afee90df7a1604111709af460458309ab5a1aba055ee41ee254b9b251a58259b29fa1096859762744e9ac73b5869b25e51223854d9f86adbb37fe69f3e5d1c0558300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000658300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000758300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000858300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000958300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f58300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006b636572746966696361746559027e3082027a30820201a00302010202100192e4188fef781d0000000067366a8d300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663733613462346362373463633966322e75732d656173742d312e6177732e6e6974726f2d656e636c61766573301e170d3234313131343231323432365a170d3234313131353030323432395a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30663733613462346362373463633966322d656e63303139326534313838666566373831642e75732d656173742d312e6177733076301006072a8648ce3d020106052b810400220362000442e0526fc41af71feac64fc6f68a8ac8aae831a9e945ab7d482b842acaf05d6b762d00cbc2115da270187c44597b1c16dcf497c70e543b41612e9041ea143d11d58bd1c847496e5d41ec78a49fe445348cf9a47af9387e0451d9ec145b56ec12a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030367003064023078001466c0c64293b9bde3d0834edb67ff18417f6075a8f7d137701e10164ce6cf45c508bf383ed0d8d41c51a5977a43023033cb8e4a6ad2686b86c2533accbab5dd5e98cf25d3612b1a48502f327ce00acc921641242d5a3a27d222df1f7dfc3e2c68636162756e646c65845902153082021130820196a003020102021100f93175681b90afe11d46ccb4e4e7f856300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3139313032383133323830355a170d3439313032383134323830355a3049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004fc0254eba608c1f36870e29ada90be46383292736e894bfff672d989444b5051e534a4b1f6dbe3c0bc581a32b7b176070ede12d69a3fea211b66e752cf7dd1dd095f6f1370f4170843d9dc100121e4cf63012809664487c9796284304dc53ff4a3423040300f0603551d130101ff040530030101ff301d0603551d0e041604149025b50dd90547e796c396fa729dcf99a9df4b96300e0603551d0f0101ff040403020186300a06082a8648ce3d0403030369003066023100a37f2f91a1c9bd5ee7b8627c1698d255038e1f0343f95b63a9628c3d39809545a11ebcbf2e3b55d8aeee71b4c3d6adf3023100a2f39b1605b27028a5dd4ba069b5016e65b4fbde8fe0061d6a53197f9cdaf5d943bc61fc2beb03cb6fee8d2302f3dff65902c2308202be30820245a003020102021100ab314210a819b4842e3be045e7daddbe300a06082a8648ce3d0403033049310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753311b301906035504030c126177732e6e6974726f2d656e636c61766573301e170d3234313131333037333235355a170d3234313230333038333235355a3064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d343834633637303131656563376235332e75732d656173742d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b8104002203620004cbd3e3fe8793852d952a214ee1c7f17e13eff238c5952ffc6c48f2b8e70beec10194585089829f4818d012a6061cdc9f4d8c5a67aada1233f75b65d3f7704e1c02460cfcc74f0e94193c8d4030f6d1662de0427836c1d32c571c919230fae73aa381d53081d230120603551d130101ff040830060101ff020102301f0603551d230418301680149025b50dd90547e796c396fa729dcf99a9df4b96301d0603551d0e04160414b5f0f617140aa7057c7977f361eee896fd9a58b4300e0603551d0f0101ff040403020186306c0603551d1f046530633061a05fa05d865b687474703a2f2f6177732d6e6974726f2d656e636c617665732d63726c2e73332e616d617a6f6e6177732e636f6d2f63726c2f61623439363063632d376436332d343262642d396539662d3539333338636236376638342e63726c300a06082a8648ce3d04030303670030640230038362cf11e189755d6a2306d728a7f356740eefe623d5e0e9e7c33c1b061ade2224127ac3a2e4bce60b43fc8c53326902306aceccf6f45a8d5c066bd10ce3ffaeeebdee56eedb86deb18ea22172c07196750924dd8f4656c70bd95eb6714cb8ecdd59031a308203163082029ba0030201020211009a0f4f29c1649826edb5b5f9f93b6326300a06082a8648ce3d0403033064310b3009060355040613025553310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533136303406035504030c2d343834633637303131656563376235332e75732d656173742d312e6177732e6e6974726f2d656e636c61766573301e170d3234313131343034323230325a170d3234313132303033323230325a308189313c303a06035504030c33373532313933346262636164353432622e7a6f6e616c2e75732d656173742d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c653076301006072a8648ce3d020106052b810400220362000496f4565c489625767e8e2d3006ba06bd48ba3e384027a205b93d1ad4958128887c38ddbb2f4922888708ef0985e1e5d3bd73b33f86785ac66a204eed3a6b663686434f64e19fb39cd7b33068edb2108b79774a961e7080cb1b4eaa60a5e63e22a381ea3081e730120603551d130101ff040830060101ff020101301f0603551d23041830168014b5f0f617140aa7057c7977f361eee896fd9a58b4301d0603551d0e0416041484b6dc9994365b56081f5d1bc8ee21f58e45d7df300e0603551d0f0101ff0404030201863081800603551d1f047930773075a073a071866f687474703a2f2f63726c2d75732d656173742d312d6177732d6e6974726f2d656e636c617665732e73332e75732d656173742d312e616d617a6f6e6177732e636f6d2f63726c2f34396230376261342d303533622d346435622d616434612d3364626533653065396637652e63726c300a06082a8648ce3d0403030369003066023100d00c2999e66fbcce624d91aedf41f5532b04c300c86a61d78ed968716a7f7ff565e2c361f4f46fe5c5486a9d2bfe0d60023100bc46872a45820fb552b926d420d4f6a1be831bb26821d374e95bff5ed042b3313465b5b4cde79f16f6a57bd5b541353c5902c3308202bf30820245a003020102021500eaa3f0b662c2a61c96f94194fa33d5baf26eeb84300a06082a8648ce3d040303308189313c303a06035504030c33373532313933346262636164353432622e7a6f6e616c2e75732d656173742d312e6177732e6e6974726f2d656e636c61766573310c300a060355040b0c03415753310f300d060355040a0c06416d617a6f6e310b3009060355040613025553310b300906035504080c0257413110300e06035504070c0753656174746c65301e170d3234313131343130313032345a170d3234313131353130313032345a30818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30663733613462346362373463633966322e75732d656173742d312e6177732e6e6974726f2d656e636c617665733076301006072a8648ce3d020106052b81040022036200040fe46adf864a558a00a9ca4b64ece5ba124ed1d29656a1f16ca71d0dc8fca56b0fb15aafd309f6258374e8c7b4a5b0521c76d1812a7873474dae9322aef1cd782db19fc2ece4d36fa08acbe65e4bec2a3cfe70960d179778ea7e7711f827b36ea366306430120603551d130101ff040830060101ff020100300e0603551d0f0101ff040403020204301d0603551d0e041604143e40d423bf86e9565c378487843389bd2f471a56301f0603551d2304183016801484b6dc9994365b56081f5d1bc8ee21f58e45d7df300a06082a8648ce3d0403030368003065023100c2767f29cc6e40e087617cf680d81e3b77962c29d8ace426b3c4a62a560354da73de6f80986d44da2593a3c268fea94302306056e2f3c88c30170c4940f578acc279a01fe689123e81def4f8c313e1f0cbc44a562a171d12810e847e441aee233f676a7075626c69635f6b6579f669757365725f6461746158205a264748a62368075d34b9494634a3e096e0e48f6647f965b81d2a653de684f2656e6f6e6365f65860284d57f029e1b3beb76455a607b9a86360d6451370f718a0d7bdcad729eea248c25461166ab684ad31fb52713918ee3e401d1b56251d6f9d85bf870e850e0b47559d17091778dbafc3d1989a94bd54c0991053675dcc3686402b189172aae196";
    let mut clock = sui::clock::create_for_testing(ctx);
    clock.set_for_testing(1731627987382 + 3 * 60 * 60 * 1000);
    nitro_attestation::load_nitro_attestation(payload, &clock);

    scenario.end();
    clock.destroy_for_testing();
}
