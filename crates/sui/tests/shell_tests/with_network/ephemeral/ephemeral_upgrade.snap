---
source: crates/sui/tests/shell_tests.rs
---
----- script -----
#!/usr/bin/env bash
# Copyright (c) Mysten Labs, Inc.
# SPDX-License-Identifier: Apache-2.0

# Test an ephemeral upgrade workflow. We have
# B --> A

extract_published() {
  echo "=== current state of pub file (only shows safe for snapshot information) ==="
  awk '
    /^\[\[published\]\]/ {
      inpub=1
      print
      next
    }

    inpub && /^source[[:space:]]*=/ {
      line = $0
      gsub(/["'\'']/, "", line)
      print line
      next
    }

    inpub && /^version[[:space:]]*=/ {
      print
      print ""
      inpub=0
    }
  ' "$@"
}

echo "=== test-publish a, then test-publish b, then add a module to b & upgrade b ==="

sui client --client.config $CONFIG \
  test-publish --build-env testnet --pubfile-path Pub.local.toml a > /dev/null

echo "=== published a ==="
extract_published Pub.local.toml

sui client --client.config $CONFIG \
  test-publish --build-env testnet --pubfile-path Pub.local.toml b > /dev/null

echo "=== published b ==="
extract_published Pub.local.toml

echo "module b::new_module; public fun b() { a::a::a() }" >> b/sources/new_module.move

sui client --client.config $CONFIG \
  test-upgrade --build-env testnet --pubfile-path Pub.local.toml b > /dev/null

echo "=== upgraded b ==="
extract_published Pub.local.toml

sui client --client.config $CONFIG \
  test-upgrade --build-env testnet --pubfile-path Pub.local.toml a > /dev/null

echo "=== upgraded a ==="
extract_published Pub.local.toml

# Try to do an incompatible upgrade to make sure we detect errors properly in the command
echo "=== expect to fail when upgrading a because it is not compatible with b ==="

# Does an incompatilbe update (changes public function's return type)
echo "module b::new_module; public fun b(): bool { true }" > b/sources/new_module.move

sui client --client.config $CONFIG \
  test-upgrade --build-env testnet --pubfile-path Pub.local.toml b

----- results -----
success: false
exit_code: 1
----- stdout -----
=== test-publish a, then test-publish b, then add a module to b & upgrade b ===
=== published a ===
=== current state of pub file (only shows safe for snapshot information) ===
[[published]]
source = { local = <SANDBOX_DIR>/a }
version = 1

=== published b ===
=== current state of pub file (only shows safe for snapshot information) ===
[[published]]
source = { local = <SANDBOX_DIR>/a }
version = 1

[[published]]
source = { local = <SANDBOX_DIR>/b }
version = 1

=== upgraded b ===
=== current state of pub file (only shows safe for snapshot information) ===
[[published]]
source = { local = <SANDBOX_DIR>/a }
version = 1

[[published]]
source = { local = <SANDBOX_DIR>/b }
version = 2

=== upgraded a ===
=== current state of pub file (only shows safe for snapshot information) ===
[[published]]
source = { local = <SANDBOX_DIR>/b }
version = 2

[[published]]
source = { local = <SANDBOX_DIR>/a }
version = 2

=== expect to fail when upgrading a because it is not compatible with b ===
INCLUDING DEPENDENCY MoveStdlib
INCLUDING DEPENDENCY Sui
INCLUDING DEPENDENCY a
BUILDING b
error[Compatibility E03001]: function signature mismatch
  ┌─ <SANDBOX_DIR>/b/sources/new_module.move:1:34
  │
1 │ module b::new_module; public fun b(): bool { true }
  │                                  ^ Expected 0 return types, found 1
  │
  = Functions are part of a module's public interface and cannot be removed or changed during a 'compatible' upgrade.
  = Restore the original function's return types for function 'b'.


Upgrade failed, this package requires changes to be compatible with the existing package. Its upgrade policy is set to 'compatible'. Use --skip-verify-compatibility to bypass this check locally.

----- stderr -----
[Note]: Dependency sources are no longer verified automatically during publication and upgrade. You can pass the `--verify-deps` option if you would like to verify them as part of publication or upgrade.
[Note]: Dependency sources are no longer verified automatically during publication and upgrade. You can pass the `--verify-deps` option if you would like to verify them as part of publication or upgrade.
[Note]: Dependency sources are no longer verified automatically during publication and upgrade. You can pass the `--verify-deps` option if you would like to verify them as part of publication or upgrade.
