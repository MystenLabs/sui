---
source: crates/sui/tests/shell_tests.rs
---
----- script -----
#!/usr/bin/env bash
# Copyright (c) Mysten Labs, Inc.
# SPDX-License-Identifier: Apache-2.0

# Test an ephemeral upgrade workflow. We have
# B --> A
# C --> B
# C --> A

chain_id=$(sui client --client.config $CONFIG chain-identifier)

add_env_to_toml() {
  echo "[environments]" >> $1/Move.toml
  echo "localnet = \"$chain_id\"" >> $1/Move.toml
}

add_env_to_toml a

echo "=== expect to fail when upgrading a because it is not even published yet ==="
sui client --client.config $CONFIG upgrade a

echo "=== expect to fail because we should never upgrade with --test flag ==="
sui client --client.config $CONFIG upgrade a --test

----- results -----
success: false
exit_code: 1
----- stdout -----
=== expect to fail when upgrading a because it is not even published yet ===
Cannot determine the publication information. Please pass the upgrade cap with `-c <UPGRADE_CAP>`.
=== expect to fail because we should never upgrade with --test flag ===
Failed to publish the Move module(s), reason: The `publish` or `upgrade` subcommand should not be used with the `--test` flag

Code in published packages must not depend on test code.
In order to fix this and publish or upgrade the package without `--test`, remove any non-test dependencies on test-only code.
You can ensure all test-only dependencies have been removed by compiling the package normally with `sui move build`.

----- stderr -----
[Note]: Dependency sources are no longer verified automatically during publication and upgrade. You can pass the `--verify-deps` option if you would like to verify them as part of publication or upgrade.
