// can borrow imm fields after a mut borrow, but if the mut is a parent, it won't be writable

//# publish
module 0x2.field {

    struct S has copy, drop { f: u64 }

    t(s: Self.S) {
        let s_imm: &Self.S;
        let s_mut: &mut Self.S;
        let f_imm: &u64;
    label b0:
        s_imm = &s;
        s_mut = &mut s;
        f_imm = &copy(s_imm).S::f;
        return;
    }
}

//# publish
module 0x3.field {

    struct S has copy, drop { f: u64 }

    t(s: Self.S) {
        let s_imm: &Self.S;
        let s_mut: &mut Self.S;
        let f_imm: &u64;
    label b0:
        // not really after, but also allowed
        s_imm = &s;
        f_imm = &copy(s_imm).S::f;
        s_mut = &mut s;
        return;
    }
}

//# publish
module 0x4.invalid_write {

    struct S has copy, drop { f: u64 }

    t(s: Self.S) {
        let s_imm: &Self.S;
        let s_mut: &mut Self.S;
        let f_imm: &u64;
    label b0:
        s_imm = &s;
        s_mut = &mut s;
        f_imm = &copy(s_imm).S::f;
        // cannot write to s_mut because of f_imm
        *copy(s_mut) = S { f: 0 };
        return;
    }
}
