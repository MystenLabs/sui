#!/bin/bash

# Script requires sui-operations repo be locally checked out in order to kick off the antithesis workflow. If SUI_OPS_REPO is not provided then it will default to the path below.
if [ -z "$SUI_OPS_REPO" ]; then
  SUI_OPS_REPO="${HOME}/dev/sui-operations"
fi

if [ ! -d "$SUI_OPS_REPO" ]; then
  echo "sui-operations repo directory $SUI_OPS_REPO does not exist. Please make sure you have correctly set the sui-operatios repo directory." >&2
  exit 1
fi

# check if git repo is dirty
if ! git diff --quiet --exit-code -- $path || ! git diff --cached --quiet --exit-code -- $path; then
  echo "Warning: git repo is dirty"
fi

# parse options
while getopts t:d:sua:l:T:c:S:p:n:C:h flag
do
    case "${flag}" in
        t) TEST_DURATION=${OPTARG};;
        s) SPLIT_VERSION=true;;
        d) DESCRIPTION=${OPTARG};;
        u) UPGRADE=true;;
        a) ALT_COMMIT=${OPTARG};;
        l) LOG_LEVEL=${OPTARG};;
        T) TIDEHUNTER_COMMIT=${OPTARG};;
        c) CONFIG_COMMIT=${OPTARG};;
        S) STRESS_COMMIT=${OPTARG};;
        p) PROTOCOL_CONFIG_OVERRIDE=${OPTARG};;
        n) TEST_NAME=${OPTARG};;
        C) SUI_COMMIT=${OPTARG};;
        h) echo "Usage: run-antithesis-tests [options]"
           echo "  -t test_duration        Antithesis test duration in hours (default: 0.25)"
           echo "  -s                      Split version mode (uses merge-base as primary commit)"
           echo "  -d description          Description of the test run"
           echo "  -u                      Upgrade test type"
           echo "  -a alt_commit           Additional sha for split-cluster upgrade test"
           echo "  -l log_level            Logging filter for sui-node (no spaces allowed)"
           echo "  -T tidehunter_commit    Tidehunter repo sha (if unset, rocksdb will be used)"
           echo "  -c config_commit        Sha for config image"
           echo "  -S stress_commit        Sui repo sha for stress image"
           echo "  -p protocol_override    Protocol config override (none, testnet, mainnet)"
           echo "  -n test_name            Name to group test history"
           echo "  -C sui_commit           Sui repo sha (default: current HEAD)"
           exit 0;;
    esac
done

if [ -z "$TEST_DURATION" ]; then
  TEST_DURATION=0.25
fi

if [ -z "$SUI_COMMIT" ]; then
  SUI_COMMIT=$(git rev-parse HEAD)
fi

remote_branches=$(git branch -r --contains "$branch" 2>/dev/null)
if [ -z "$remote_branches" ]; then
  echo "Error: Current commit $branch has not been pushed to remote. Please push your changes first." >&2
  exit 1
fi

if [ -z "$DESCRIPTION" ]; then
  tracking_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream} 2>/dev/null)
  if [ -n "$tracking_branch" ]; then
    DESCRIPTION=${tracking_branch#origin/}
  else
    local_branch=$(git rev-parse --abbrev-ref HEAD)
    if [ "$local_branch" != "HEAD" ]; then
      DESCRIPTION=$local_branch
    fi
  fi
fi

if [ -n "$DESCRIPTION" ]; then
  echo "Description: $DESCRIPTION"
fi

if [ "$SPLIT_VERSION" = true ]; then
  if [ -n "$ALT_COMMIT" ]; then
    COMMIT=$ALT_COMMIT
  else
    COMMIT=$(git merge-base origin/main HEAD)
  fi
  ALT_COMMIT=$SUI_COMMIT
else
  COMMIT=$SUI_COMMIT
fi

cd $SUI_OPS_REPO

cmd="gh workflow run .github/workflows/run-antithesis-tests.yaml -f sui_commit=$COMMIT -f test_duration=$TEST_DURATION"

if [ -n "$DESCRIPTION" ]; then
  cmd="$cmd -f description='$DESCRIPTION'"
fi

if [ -n "$ALT_COMMIT" ]; then
  cmd="$cmd -f sui_commit_alt=$ALT_COMMIT"
fi 

if [ "$UPGRADE" = true ]; then
  cmd="$cmd -f test_type=upgrade"
fi

if [ -n "$LOG_LEVEL" ]; then
  if [[ "$LOG_LEVEL" =~ [[:space:]] ]]; then
    echo "Error: LOG_LEVEL cannot contain spaces"
    exit 1
  fi
  cmd="$cmd -f rust_log_filter=$LOG_LEVEL"
fi

if [ -n "$TIDEHUNTER_COMMIT" ]; then
  cmd="$cmd -f tidehunter_commit=$TIDEHUNTER_COMMIT"
fi

if [ -n "$CONFIG_COMMIT" ]; then
  cmd="$cmd -f config_commit=$CONFIG_COMMIT"
fi

if [ -n "$STRESS_COMMIT" ]; then
  cmd="$cmd -f stress_commit=$STRESS_COMMIT"
fi

if [ -n "$PROTOCOL_CONFIG_OVERRIDE" ]; then
  cmd="$cmd -f protocol_config_override=$PROTOCOL_CONFIG_OVERRIDE"
fi

if [ -n "$TEST_NAME" ]; then
  cmd="$cmd -f test_name=$TEST_NAME"
fi

echo Running: $cmd

$cmd

GH_USER=$(gh api user | jq -r .login)

# need a small delay to allow the run to be created before listing
sleep 5

RUN_ID=$(gh run list --user $GH_USER --workflow .github/workflows/run-antithesis-tests.yaml --limit 1 --json databaseId -q '.[0].databaseId')

echo "Run ID: $RUN_ID"

URL=$(gh run view "$RUN_ID" --json url -q '.url')
echo "URL: $URL"
