# Copyright (c) Mysten Labs, Inc.
# SPDX-License-Identifier: Apache-2.0

query queryTransactionBlocks(
	$first: Int
	$last: Int
	$before: String
	$after: String
	$showBalanceChanges: Boolean = false
	$showEffects: Boolean = false
	$showEvents: Boolean = false
	$showInput: Boolean = false
	$showObjectChanges: Boolean = false
	$showRawInput: Boolean = false
	$filter: TransactionBlockFilter
) {
	transactionBlockConnection(
		first: $first
		after: $after
		last: $last
		before: $before
		filter: $filter
	) {
		pageInfo {
			hasNextPage
			hasPreviousPage
			startCursor
			endCursor
		}
		nodes {
			...RPC_TRANSACTION_FIELDS
		}
	}
}

query getTransactionBlock(
	$digest: String!
	$showBalanceChanges: Boolean = false
	$showEffects: Boolean = false
	$showEvents: Boolean = false
	$showInput: Boolean = false
	$showObjectChanges: Boolean = false
	$showRawInput: Boolean = false
) {
	transactionBlock(digest: $digest) {
		...RPC_TRANSACTION_FIELDS
	}
}

query multiGetTransactionBlocks(
	$digests: [String!]!
	$limit: Int
	$cursor: String
	$showBalanceChanges: Boolean = false
	$showEffects: Boolean = false
	$showEvents: Boolean = false
	$showInput: Boolean = false
	$showObjectChanges: Boolean = false
	$showRawInput: Boolean = false
) {
	transactionBlockConnection(first: $limit, after: $cursor, filter: { transactionIds: $digests }) {
		pageInfo {
			hasNextPage
			hasPreviousPage
			startCursor
			endCursor
		}
		nodes {
			...RPC_TRANSACTION_FIELDS
		}
	}
}

fragment RPC_TRANSACTION_FIELDS on TransactionBlock {
	digest
	rawTransaction: bcs @include(if: $showInput)
	rawTransaction: bcs @include(if: $showRawInput)
	sender {
		address
	}

	signatures
	events(first: 50) @include(if: $showEvents) {
		nodes {
			...RPC_EVENTS_FIELDS
		}
	}
	effects {
		checkpoint {
			sequenceNumber
		}
		timestamp
		balanceChanges @include(if: $showBalanceChanges) {
			coinType {
				repr
			}
			owner {
				asAddress {
					address
				}
				asObject {
					address
				}
			}
			amount
		}
		dependencies @include(if: $showEffects) {
			digest
		}
		status @include(if: $showEffects)
		gasEffects @include(if: $showEffects) {
			gasObject {
				owner {
					asAddress {
						address
					}
					asObject {
						address
					}
				}
				digest
				version
				address
			}
			gasSummary {
				storageCost
				storageRebate
				nonRefundableStorageFee
				computationCost
			}
		}
		executedEpoch: epoch @include(if: $showEffects) {
			epochId
		}

		objectChanges @include(if: $showEffects) {
			idCreated
			idDeleted
			inputState {
				version
				digest
				address
			}
			outputState {
				version
				digest
				address
				owner {
					asAddress {
						address
					}
					asObject {
						address
					}
				}
			}
		}

		objectChanges @include(if: $showObjectChanges) {
			idCreated
			idDeleted
			inputState {
				version
				digest
				address
				asMoveObject {
					contents {
						type {
							repr
						}
					}
				}
				owner {
					asAddress {
						address
					}
					asObject {
						address
					}
				}
			}
			outputState {
				version
				digest
				address
				asMoveObject {
					contents {
						type {
							repr
						}
					}
				}
				owner {
					asAddress {
						address
					}
					asObject {
						address
					}
				}
			}
		}
	}
}
